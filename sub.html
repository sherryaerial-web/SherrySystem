<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sherry Aerial ä»£èª²é ˜å–ç³»çµ±</title>
  <style>
    :root { --primary: #34495e; --bg: #f8fafb; --success: #27ae60; }
    body { font-family: -apple-system, "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); padding: 15px; color: #444; }
    .card { background: white; padding: 22px; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); margin-bottom: 20px; }
    h2 { color: var(--primary); font-size: 1.25rem; margin-top: 0; display: flex; align-items: center; gap: 10px; }
    h2::before { content: ""; width: 5px; height: 20px; background: var(--primary); border-radius: 10px; }
    
    label { font-size: 14px; color: #7f8c8d; margin-bottom: 10px; display: block; font-weight: 500; }
    select { width: 100%; padding: 14px; margin-bottom: 10px; border-radius: 12px; border: 1.5px solid #eee; font-size: 16px; background: #fff; appearance: none; cursor: pointer; }

    /* èª²ç¨‹å¡ç‰‡æ¨£å¼ */
    .course-card { 
      border: 1px solid #f0f0f0; 
      padding: 18px; 
      border-radius: 15px; 
      margin-bottom: 15px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      transition: 0.2s;
    }
    .course-card:hover { border-color: var(--primary); background: #fdfdfd; }
    .course-info { flex-grow: 1; }
    .course-date { font-size: 1.1rem; font-weight: 700; color: #2c3e50; margin-bottom: 4px; }
    .course-detail { font-size: 14px; color: #7f8c8d; }
    .course-instructor { color: #34495e; font-weight: 600; background: #f0f2f5; padding: 2px 8px; border-radius: 4px; font-size: 12px; }

    /* é ˜å–æŒ‰éˆ• */
    .claim-btn { 
      background: var(--success); 
      color: white; 
      border: none; 
      padding: 10px 20px; 
      border-radius: 10px; 
      font-weight: bold; 
      cursor: pointer; 
      font-size: 14px;
      white-space: nowrap;
      margin-left: 15px;
    }
    .claim-btn:active { transform: scale(0.95); opacity: 0.9; }
    .loading-text { text-align: center; color: #bdc3c7; padding: 40px; font-size: 14px; }
    
    /* ç©ºç‹€æ…‹æç¤º */
    .empty-msg { text-align: center; padding: 40px; color: #95a5a6; font-size: 15px; }
  </style>
</head>
<body>

  <div class="card">
    <h2>ğŸ‘¤ é ˜å–èº«ä»½</h2>
    <label>è«‹é¸æ“‡æ‚¨çš„åå­— (ä»£èª²è€å¸«)ï¼š</label>
    <select id="meSelect" onchange="loadAvailableCourses()">
      <option value="">-- æˆ‘æ˜¯å“ªä½è€å¸«ï¼Ÿ --</option>
    </select>
  </div>

  <div class="card">
    <h2>ğŸ“¢ å¾…é ˜å–èª²è¡¨</h2>
    <div id="listArea"><div class="loading-text">è«‹å…ˆé¸æ“‡æ‚¨çš„èº«ä»½...</div></div>
  </div>

  <script>
    const APP_URL = "https://script.google.com/macros/s/AKfycbyJADHe_DZdNIbfv_KPewAcBekEond-5Fw63i-RWCd1mHl_O9uGAQ-LTnzENZshjnhe/exec";
    let allPendingCourses = [];

    window.onload = () => {
      // 1. è¼‰å…¥è€å¸«åå–®
      fetch(`${APP_URL}?action=getTeachers`).then(r => r.json()).then(data => {
        const s = document.getElementById('meSelect');
        s.innerHTML += data.map(t => `<option value="${t['æŒ‡å°è€…']}">${t['æŒ‡å°è€…']}</option>`).join('');
      });
    };

    function loadAvailableCourses() {
      const myName = document.getElementById('meSelect').value;
      const area = document.getElementById('listArea');
      
      if (!myName) {
        area.innerHTML = '<div class="loading-text">è«‹å…ˆé¸æ“‡æ‚¨çš„èº«ä»½...</div>';
        return;
      }

      area.innerHTML = '<div class="loading-text">æœå°‹ä¸­...</div>';

      // 2. è¼‰å…¥çœ‹æ¿è³‡æ–™ (å·¥ä½œè¡¨1)
      fetch(`${APP_URL}?action=getBoard`).then(r => r.json()).then(data => {
        // éæ¿¾é‚è¼¯ï¼š
        // 1. ç‹€æ…‹å¿…é ˆæ˜¯ã€Œç¢ºèªä¸­ã€
        // 2. æŒ‡å°è€…ã€Œä¸èƒ½ã€æ˜¯ç›®å‰é¸å–çš„è€å¸« (æœ¬äºº)
        // 3. é‚„æ²’æœ‰ä»£èª²è€å¸«é ˜å–
        const available = data.filter(c => 
          c['ç‹€æ…‹'] === 'ç¢ºèªä¸­' && 
          String(c['æŒ‡å°è€…']).trim() !== myName && 
          (!c['ä»£èª²è€å¸«'] || c['ä»£èª²è€å¸«'] === "")
        );

        // æ’åºï¼šæ—¥æœŸæ—©çš„æ’å‰é¢
        available.sort((a, b) => {
          const valA = new Date(a['æ—¥æœŸ'].replace(/\//g, '-') + ' ' + (a['æ™‚é–“'].includes('T') ? a['æ™‚é–“'].split('T')[1].substring(0,5) : a['æ™‚é–“'])).getTime();
          const valB = new Date(b['æ—¥æœŸ'].replace(/\//g, '-') + ' ' + (b['æ™‚é–“'].includes('T') ? b['æ™‚é–“'].split('T')[1].substring(0,5) : b['æ™‚é–“'])).getTime();
          return valA - valB;
        });

        renderList(available, myName);
      });
    }

    function formatDateWithDay(d) {
      if (!d) return "";
      let dateObj = new Date(d);
      if (isNaN(dateObj.getTime())) return d;
      const weekdays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
      return `${dateObj.getMonth() + 1}/${dateObj.getDate()} (${weekdays[dateObj.getDay()]})`;
    }

    function renderList(list, myName) {
      const area = document.getElementById('listArea');
      if (list.length === 0) {
        area.innerHTML = '<div class="empty-msg">ğŸŒµ ç›®å‰æ²’æœ‰å¯é ˜å–çš„ä»£èª²é‚€è«‹<br>(æˆ–å‰©é¤˜èª²ç¨‹çš†ç‚ºæ‚¨çš„è«‹å‡)</div>';
        return;
      }

      area.innerHTML = list.map(c => `
        <div class="course-card">
          <div class="course-info">
            <div class="course-date">${formatDateWithDay(c['æ—¥æœŸ'])} ${c['æ™‚é–“']}</div>
            <div class="course-detail">
              <span class="course-instructor">åŸæŒ‡å°è€…ï¼š${c['æŒ‡å°è€…']}</span>
              <div style="margin-top:5px;">èª²ç¨‹ï¼š${c['èª²ç¨‹']}</div>
            </div>
          </div>
          <button class="claim-btn" onclick="claimCourse('${c['æ—¥æœŸ']}', '${c['æ™‚é–“']}', '${c['æŒ‡å°è€…']}')">é ˜å–</button>
        </div>
      `).join('');
    }

    function claimCourse(date, time, instructor) {
      const myName = document.getElementById('meSelect').value;
      if (!confirm(`ç¢ºå®šè¦é ˜å– ${instructor} è€å¸«åœ¨ ${date} ${time} çš„èª²ç¨‹å—ï¼Ÿ`)) return;

      const url = `${APP_URL}?action=subClaim&date=${encodeURIComponent(date)}&time=${encodeURIComponent(time)}&instructor=${encodeURIComponent(instructor)}&subTeacher=${encodeURIComponent(myName)}`;
      
      fetch(url).then(r => r.json()).then(res => {
        if (res.status === "success") {
          alert("é ˜å–æˆåŠŸï¼");
          loadAvailableCourses(); // é‡æ–°æ•´ç†åˆ—è¡¨
        } else {
          alert("é ˜å–å¤±æ•—ï¼š" + res.message);
        }
      });
    }
  </script>
</body>
</html>
