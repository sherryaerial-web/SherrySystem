<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sherry Aerial ä»£èª²æ‰¹æ¬¡é ˜å–</title>
  <style>
    :root { --primary: #34495e; --bg: #f8fafb; --success: #27ae60; }
    body { font-family: -apple-system, "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); padding: 15px; color: #444; padding-bottom: 80px; }
    .card { background: white; padding: 22px; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); margin-bottom: 20px; }
    h2 { color: var(--primary); font-size: 1.2rem; margin-top: 0; display: flex; align-items: center; gap: 8px; }
    h2::before { content: ""; width: 4px; height: 18px; background: var(--primary); border-radius: 10px; }
    
    select { width: 100%; padding: 12px; border-radius: 12px; border: 1.5px solid #eee; font-size: 16px; margin-bottom: 10px; background: #fff; appearance: none; }

    /* æ‰¹æ¬¡é ˜å–å¡ç‰‡ */
    .course-card { 
      background: #fff;
      border: 1px solid #f0f0f0; 
      padding: 18px; 
      border-radius: 16px; 
      margin-bottom: 15px; 
      display: flex; 
      align-items: center;
      gap: 15px;
      transition: 0.2s;
      cursor: pointer;
    }
    /* ç•¶å‹¾é¸æ¡†é¸ä¸­æ™‚ï¼Œå¡ç‰‡è®Šè‰² */
    .course-card.selected { border-color: var(--success); background: #f0fff4; }

    .course-info { flex: 1; display: flex; flex-direction: column; gap: 4px; }
    .course-time { font-size: 1.1rem; font-weight: 800; color: #2c3e50; }
    .course-title { font-size: 14px; color: #34495e; font-weight: 600; }
    .instructor-tag { font-size: 12px; color: #7f8c8d; background: #f1f2f6; padding: 2px 8px; border-radius: 6px; width: fit-content; margin-top: 4px; }

    /* å‹¾é¸æ¡†æ¨£å¼æ”¾å¤§ */
    .batch-chk { width: 22px; height: 22px; cursor: pointer; accent-color: var(--success); }

    /* åº•éƒ¨å›ºå®šæŒ‰éˆ•æ¬„ */
    .footer-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: white; padding: 15px 20px;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
      display: none; /* æœ‰é¸æ“‡æ™‚æ‰é¡¯ç¤º */
      z-index: 100;
    }
    .submit-btn { 
      width: 100%; background: var(--success); color: white; border: none; 
      padding: 16px; border-radius: 15px; font-size: 16px; font-weight: bold; 
      cursor: pointer; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
    }
    .submit-btn:disabled { background: #bdc3c7; box-shadow: none; }

    .empty-msg { text-align: center; padding: 40px; color: #bdc3c7; font-size: 14px; }
  </style>
</head>
<body>

  <div class="card">
    <h2>ğŸ‘¤ é ˜å–èº«ä»½</h2>
    <select id="meSelect" onchange="loadAvailableCourses()">
      <option value="">-- æˆ‘æ˜¯å“ªä½è€å¸«ï¼Ÿ --</option>
    </select>
  </div>

  <div class="card">
    <h2>ğŸ“¢ å¾…é ˜å–èª²è¡¨</h2>
    <div id="listArea"><div class="empty-msg">è«‹å…ˆé¸å–æ‚¨çš„åå­—...</div></div>
  </div>

  <div id="footerBar" class="footer-bar">
    <button id="batchBtn" class="submit-btn" onclick="submitBatchClaim()">ç¢ºèªé ˜å– (0)</button>
  </div>

  <script>
    const APP_URL = "https://script.google.com/macros/s/AKfycbyJADHe_DZdNIbfv_KPewAcBekEond-5Fw63i-RWCd1mHl_O9uGAQ-LTnzENZshjnhe/exec";

    window.onload = () => {
      fetch(`${APP_URL}?action=getTeachers`).then(r => r.json()).then(data => {
        const s = document.getElementById('meSelect');
        s.innerHTML += data.map(t => `<option value="${t['æŒ‡å°è€…']}">${t['æŒ‡å°è€…']}</option>`).join('');
      });
    };

    function loadAvailableCourses() {
      const myName = document.getElementById('meSelect').value;
      const area = document.getElementById('listArea');
      document.getElementById('footerBar').style.display = 'none';
      if (!myName) return;

      area.innerHTML = '<div class="empty-msg">æ›´æ–°ä¸­...</div>';

      fetch(`${APP_URL}?action=getBoard`).then(r => r.json()).then(data => {
        const available = data.filter(c => 
          c['ç‹€æ…‹'] === 'ç¢ºèªä¸­' && 
          String(c['æŒ‡å°è€…']).trim() !== myName && 
          (!c['ä»£èª²è€å¸«'] || c['ä»£èª²è€å¸«'] === "")
        );

        available.sort((a, b) => {
          const valA = new Date(a['æ—¥æœŸ'] + ' ' + (a['æ™‚é–“'].includes('T') ? a['æ™‚é–“'].split('T')[1].substring(0,5) : a['æ™‚é–“'])).getTime();
          const valB = new Date(b['æ—¥æœŸ'] + ' ' + (b['æ™‚é–“'].includes('T') ? b['æ™‚é–“'].split('T')[1].substring(0,5) : b['æ™‚é–“'])).getTime();
          return valA - valB;
        });

        renderList(available);
      });
    }

    function renderList(list) {
      const area = document.getElementById('listArea');
      if (list.length === 0) {
        area.innerHTML = '<div class="empty-msg">ğŸŒµ ç›®å‰æ²’æœ‰å¯é ˜å–çš„ä»£èª²èª²ç¨‹</div>';
        return;
      }

      area.innerHTML = list.map((c, index) => `
        <div class="course-card" id="card-${index}" onclick="toggleSelect(${index})">
          <input type="checkbox" class="batch-chk" id="chk-${index}" 
                 data-date="${c['æ—¥æœŸ']}" data-time="${c['æ™‚é–“']}" data-instructor="${c['æŒ‡å°è€…']}"
                 onclick="event.stopPropagation(); updateBtn();">
          <div class="course-info">
            <div class="course-time">${formatDateWithDay(c['æ—¥æœŸ'])} ${c['æ™‚é–“']}</div>
            <div class="course-title">èª²ç¨‹ï¼š${c['èª²ç¨‹']}</div>
            <div class="instructor-tag">åŸæŒ‡å°è€…ï¼š${c['æŒ‡å°è€…']}</div>
          </div>
        </div>
      `).join('');
    }

    function formatDateWithDay(d) {
      if (!d) return "";
      let dateObj = new Date(d);
      if (isNaN(dateObj.getTime())) return d;
      const weekdays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
      return `${dateObj.getMonth() + 1}/${dateObj.getDate()} (${weekdays[dateObj.getDay()]})`;
    }

    // é»æ“Šå¡ç‰‡ä¹Ÿèƒ½é¸ä¸­
    function toggleSelect(index) {
      const chk = document.getElementById(`chk-${index}`);
      chk.checked = !chk.checked;
      updateBtn();
    }

    // æ›´æ–°åº•éƒ¨æŒ‰éˆ•æ•¸å­—èˆ‡é¡¯ç¤ºç‹€æ…‹
    function updateBtn() {
      const chks = document.querySelectorAll('.batch-chk:checked');
      const footer = document.getElementById('footerBar');
      const btn = document.getElementById('batchBtn');
      
      // æ›´æ–°å¡ç‰‡é¸å–è¦–è¦ºæ•ˆæœ
      document.querySelectorAll('.course-card').forEach((card, idx) => {
        if (document.getElementById(`chk-${idx}`).checked) card.classList.add('selected');
        else card.classList.remove('selected');
      });

      if (chks.length > 0) {
        footer.style.display = 'block';
        btn.innerText = `ç¢ºèªé ˜å– (${chks.length}) å ‚èª²`;
      } else {
        footer.style.display = 'none';
      }
    }

    async function submitBatchClaim() {
      const myName = document.getElementById('meSelect').value;
      const chks = Array.from(document.querySelectorAll('.batch-chk:checked'));
      if (!confirm(`ç¢ºå®šè¦é ˜å–é€™ ${chks.length} å ‚èª²å—ï¼Ÿ`)) return;

      const btn = document.getElementById('batchBtn');
      btn.disabled = true;
      btn.innerText = "è™•ç†ä¸­...";

      let successCount = 0;

      // é€ä¸€ç™¼é€è«‹æ±‚
      for (let chk of chks) {
        const date = chk.dataset.date;
        const time = chk.dataset.time;
        const instructor = chk.dataset.instructor;
        const url = `${APP_URL}?action=subClaim&date=${encodeURIComponent(date)}&time=${encodeURIComponent(time)}&instructor=${encodeURIComponent(instructor)}&subTeacher=${encodeURIComponent(myName)}`;
        
        try {
          const r = await fetch(url);
          const res = await r.json();
          if (res.status === "success") successCount++;
        } catch (e) {
          console.error("é ˜å–å¤±æ•—", e);
        }
      }

      alert(`é ˜å–å®Œæˆï¼æˆåŠŸé ˜å– ${successCount} å ‚èª²ã€‚`);
      loadAvailableCourses();
    }
  </script>
</body>
</html>
