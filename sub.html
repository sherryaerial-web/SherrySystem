<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sherry Aerial ä»£èª²é ˜å–ç³»çµ±</title>
  <style>
    :root { --primary: #34495e; --bg: #f8fafb; --success: #27ae60; }
    body { font-family: -apple-system, "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); padding: 15px; color: #444; }
    .card { background: white; padding: 22px; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); margin-bottom: 20px; }
    h2 { color: var(--primary); font-size: 1.2rem; margin-top: 0; display: flex; align-items: center; gap: 8px; }
    h2::before { content: ""; width: 4px; height: 18px; background: var(--primary); border-radius: 10px; }
    
    label { font-size: 14px; color: #7f8c8d; margin-bottom: 8px; display: block; }
    select { width: 100%; padding: 12px; border-radius: 12px; border: 1.5px solid #eee; font-size: 16px; margin-bottom: 10px; background: #fff; }

    /* å¡ç‰‡è¨­è¨ˆå„ªåŒ– */
    .course-card { 
      background: #fff;
      border: 1px solid #f0f0f0; 
      padding: 20px; 
      border-radius: 16px; 
      margin-bottom: 15px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      transition: 0.2s;
    }
    .course-info { flex: 1; }
    
    /* 1. èª²ç¨‹åç¨±ï¼šæœ€é†’ç›® */
    .course-title { font-size: 1.15rem; font-weight: 800; color: #2c3e50; margin-bottom: 4px; display: block; }
    
    /* æ—¥æœŸæ™‚é–“èˆ‡æŒ‡å°è€… */
    .course-meta { font-size: 14px; color: #7f8c8d; display: flex; flex-direction: column; gap: 4px; }
    .instructor-tag { display: inline-block; background: #f0f2f5; color: #576574; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; width: fit-content; }
    .time-text { color: #34495e; font-weight: 500; }

    .claim-btn { 
      background: var(--success); 
      color: white; 
      border: none; 
      padding: 12px 24px; 
      border-radius: 12px; 
      font-weight: bold; 
      cursor: pointer; 
      font-size: 15px;
      margin-left: 15px;
      box-shadow: 0 4px 10px rgba(39, 174, 96, 0.2);
    }
    .claim-btn:active { transform: scale(0.95); }
    .empty-msg { text-align: center; padding: 40px; color: #bdc3c7; }
  </style>
</head>
<body>

  <div class="card">
    <h2>ğŸ‘¤ é ˜å–èº«ä»½</h2>
    <select id="meSelect" onchange="loadAvailableCourses()">
      <option value="">-- æˆ‘æ˜¯å“ªä½è€å¸«ï¼Ÿ --</option>
    </select>
  </div>

  <div class="card">
    <h2>ğŸ“¢ å¾…é ˜å–èª²è¡¨</h2>
    <div id="listArea"><div class="empty-msg">è«‹å…ˆé¸æ“‡æ‚¨çš„èº«ä»½...</div></div>
  </div>

  <script>
    const APP_URL = "https://script.google.com/macros/s/AKfycbyJADHe_DZdNIbfv_KPewAcBekEond-5Fw63i-RWCd1mHl_O9uGAQ-LTnzENZshjnhe/exec";

    window.onload = () => {
      fetch(`${APP_URL}?action=getTeachers`).then(r => r.json()).then(data => {
        const s = document.getElementById('meSelect');
        s.innerHTML += data.map(t => `<option value="${t['æŒ‡å°è€…']}">${t['æŒ‡å°è€…']}</option>`).join('');
      });
    };

    function loadAvailableCourses() {
      const myName = document.getElementById('meSelect').value;
      const area = document.getElementById('listArea');
      if (!myName) return;

      area.innerHTML = '<div class="empty-msg">æœå°‹ä¸­...</div>';

      fetch(`${APP_URL}?action=getBoard`).then(r => r.json()).then(data => {
        // éæ¿¾ï¼š1.ç‹€æ…‹ç¢ºèªä¸­ 2.éæœ¬äºº 3.å°šæœªè¢«é ˜å–
        const available = data.filter(c => 
          c['ç‹€æ…‹'] === 'ç¢ºèªä¸­' && 
          String(c['æŒ‡å°è€…']).trim() !== myName && 
          (!c['ä»£èª²è€å¸«'] || c['ä»£èª²è€å¸«'] === "")
        );

        // æ’åºï¼šæ—©æ—¥æœŸæ’å‰é¢
        available.sort((a, b) => {
          const valA = new Date(a['æ—¥æœŸ'].replace(/\//g, '-') + ' ' + (a['æ™‚é–“'].includes('T') ? a['æ™‚é–“'].split('T')[1].substring(0,5) : a['æ™‚é–“'])).getTime();
          const valB = new Date(b['æ—¥æœŸ'].replace(/\//g, '-') + ' ' + (b['æ™‚é–“'].includes('T') ? b['æ™‚é–“'].split('T')[1].substring(0,5) : b['æ™‚é–“'])).getTime();
          return valA - valB;
        });

        renderList(available, myName);
      });
    }

    function formatDateWithDay(d) {
      if (!d) return "";
      let dateObj = new Date(d);
      if (isNaN(dateObj.getTime())) return d;
      const weekdays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
      return `${dateObj.getMonth() + 1}/${dateObj.getDate()} (${weekdays[dateObj.getDay()]})`;
    }

    function renderList(list, myName) {
      const area = document.getElementById('listArea');
      if (list.length === 0) {
        area.innerHTML = '<div class="empty-msg">ğŸŒµ ç›®å‰æ²’æœ‰å¯é ˜å–çš„ä»£èª²é‚€è«‹</div>';
        return;
      }

      area.innerHTML = list.map(c => `
        <div class="course-card">
          <div class="course-info">
            <span class="course-title">${c['èª²ç¨‹']}</span>
            <div class="course-meta">
              <span class="time-text">ğŸ—“ï¸ ${formatDateWithDay(c['æ—¥æœŸ'])} ${c['æ™‚é–“']}</span>
              <span class="instructor-tag">åŸæŒ‡å°è€…ï¼š${c['æŒ‡å°è€…']}</span>
            </div>
          </div>
          <button class="claim-btn" onclick="claimCourse('${c['æ—¥æœŸ']}', '${c['æ™‚é–“']}', '${c['æŒ‡å°è€…']}')">é ˜å–</button>
        </div>
      `).join('');
    }

    function claimCourse(date, time, instructor) {
      const myName = document.getElementById('meSelect').value;
      if (!confirm(`ç¢ºå®šè¦é ˜å–èª²ç¨‹å—ï¼Ÿ`)) return;

      const url = `${APP_URL}?action=subClaim&date=${encodeURIComponent(date)}&time=${encodeURIComponent(time)}&instructor=${encodeURIComponent(instructor)}&subTeacher=${encodeURIComponent(myName)}`;
      
      fetch(url).then(r => r.json()).then(res => {
        if (res.status === "success") {
          alert("é ˜å–æˆåŠŸï¼");
          loadAvailableCourses();
        } else {
          alert("éŒ¯èª¤ï¼š" + res.message);
        }
      });
    }
  </script>
</body>
</html>
