<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sherry Aerial ä»£èª²é ˜å–ç³»çµ±</title>
  <style>
    :root { --primary: #34495e; --bg: #f8fafb; --success: #27ae60; }
    body { font-family: -apple-system, "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); padding: 15px; color: #444; }
    .card { background: white; padding: 22px; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); margin-bottom: 20px; }
    h2 { color: var(--primary); font-size: 1.2rem; margin-top: 0; display: flex; align-items: center; gap: 8px; }
    h2::before { content: ""; width: 4px; height: 18px; background: var(--primary); border-radius: 10px; }
    
    select { width: 100%; padding: 12px; border-radius: 12px; border: 1.5px solid #eee; font-size: 16px; margin-bottom: 10px; background: #fff; appearance: none; }

    /* èª²ç¨‹å¡ç‰‡æ’åˆ—å„ªåŒ– */
    .course-card { 
      background: #fff;
      border: 1px solid #f0f0f0; 
      padding: 20px; 
      border-radius: 16px; 
      margin-bottom: 15px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      transition: 0.2s;
    }
    .course-info { flex: 1; display: flex; flex-direction: column; gap: 6px; }
    
    /* 1. æ—¥æœŸæ™‚é–“ï¼šæœ€ä¸Šæ–¹æ¨™é¡Œæ„Ÿ */
    .course-time { font-size: 1.1rem; font-weight: 800; color: #2c3e50; }
    
    /* 2. èª²ç¨‹åç¨±ï¼šä¸­é–“é‡é» */
    .course-title { font-size: 15px; color: #34495e; font-weight: 600; }
    
    /* 3. æŒ‡å°è€…ï¼šæœ€ä¸‹æ–¹æ¨™ç±¤ */
    .instructor-tag { font-size: 12px; color: #7f8c8d; background: #f1f2f6; padding: 2px 8px; border-radius: 6px; width: fit-content; }

    .claim-btn { 
      background: var(--success); 
      color: white; 
      border: none; 
      padding: 12px 24px; 
      border-radius: 12px; 
      font-weight: bold; 
      cursor: pointer; 
      font-size: 15px;
      margin-left: 10px;
    }
    .claim-btn:active { transform: scale(0.95); }
    .empty-msg { text-align: center; padding: 40px; color: #bdc3c7; font-size: 14px; }
  </style>
</head>
<body>

  <div class="card">
    <h2>ğŸ‘¤ é ˜å–èº«ä»½</h2>
    <select id="meSelect" onchange="loadAvailableCourses()">
      <option value="">-- æˆ‘æ˜¯å“ªä½è€å¸«ï¼Ÿ --</option>
    </select>
  </div>

  <div class="card">
    <h2>ğŸ“¢ å¾…é ˜å–èª²è¡¨</h2>
    <div id="listArea"><div class="empty-msg">è«‹å…ˆé¸å–æ‚¨çš„åå­—ï¼Œç³»çµ±å°‡æ’é™¤æ‚¨çš„è«‹å‡èª²ç¨‹...</div></div>
  </div>

  <script>
    const APP_URL = "https://script.google.com/macros/s/AKfycbyJADHe_DZdNIbfv_KPewAcBekEond-5Fw63i-RWCd1mHl_O9uGAQ-LTnzENZshjnhe/exec";

    window.onload = () => {
      fetch(`${APP_URL}?action=getTeachers`).then(r => r.json()).then(data => {
        const s = document.getElementById('meSelect');
        s.innerHTML += data.map(t => `<option value="${t['æŒ‡å°è€…']}">${t['æŒ‡å°è€…']}</option>`).join('');
      });
    };

    function loadAvailableCourses() {
      const myName = document.getElementById('meSelect').value;
      const area = document.getElementById('listArea');
      if (!myName) return;

      area.innerHTML = '<div class="empty-msg">éæ¿¾ä¸­...</div>';

      fetch(`${APP_URL}?action=getBoard`).then(r => r.json()).then(data => {
        // éæ¿¾é‚è¼¯ï¼š1.ç¢ºèªä¸­ 2.ã€Œæ’é™¤ã€ç›®å‰é¸å–çš„æœ¬äººåå­— 3.å°šæœªè¢«é ˜å–
        const available = data.filter(c => 
          c['ç‹€æ…‹'] === 'ç¢ºèªä¸­' && 
          String(c['æŒ‡å°è€…']).trim() !== myName && 
          (!c['ä»£èª²è€å¸«'] || c['ä»£èª²è€å¸«'] === "")
        );

        // ç”±æ—©åˆ°æ™šæ’åº
        available.sort((a, b) => {
          const valA = new Date(a['æ—¥æœŸ'] + ' ' + (a['æ™‚é–“'].includes('T') ? a['æ™‚é–“'].split('T')[1].substring(0,5) : a['æ™‚é–“'])).getTime();
          const valB = new Date(b['æ—¥æœŸ'] + ' ' + (b['æ™‚é–“'].includes('T') ? b['æ™‚é–“'].split('T')[1].substring(0,5) : b['æ™‚é–“'])).getTime();
          return valA - valB;
        });

        renderList(available);
      });
    }

    function formatDateWithDay(d) {
      if (!d) return "";
      let dateObj = new Date(d);
      if (isNaN(dateObj.getTime())) return d;
      const weekdays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
      return `${dateObj.getMonth() + 1}/${dateObj.getDate()} (${weekdays[dateObj.getDay()]})`;
    }

    function renderList(list) {
      const area = document.getElementById('listArea');
      if (list.length === 0) {
        area.innerHTML = '<div class="empty-msg">ğŸŒµ ç›®å‰æ²’æœ‰å¯é ˜å–çš„ä»£èª²èª²ç¨‹<br>(å·²è‡ªå‹•éš±è—æ‚¨çš„è«‹å‡é …)</div>';
        return;
      }

      area.innerHTML = list.map(c => `
        <div class="course-card">
          <div class="course-info">
            <div class="course-time">${formatDateWithDay(c['æ—¥æœŸ'])} ${c['æ™‚é–“']}</div>
            <div class="course-title">èª²ç¨‹ï¼š${c['èª²ç¨‹']}</div>
            <div class="instructor-tag">åŸæŒ‡å°è€…ï¼š${c['æŒ‡å°è€…']}</div>
          </div>
          <button class="claim-btn" onclick="claimCourse('${c['æ—¥æœŸ']}', '${c['æ™‚é–“']}', '${c['æŒ‡å°è€…']}')">é ˜å–</button>
        </div>
      `).join('');
    }

    function claimCourse(date, time, instructor) {
      const myName = document.getElementById('meSelect').value;
      if (!confirm(`ç¢ºå®šè¦é ˜å–ä»£èª²å—ï¼Ÿ`)) return;

      const url = `${APP_URL}?action=subClaim&date=${encodeURIComponent(date)}&time=${encodeURIComponent(time)}&instructor=${encodeURIComponent(instructor)}&subTeacher=${encodeURIComponent(myName)}`;
      
      fetch(url).then(r => r.json()).then(res => {
        if (res.status === "success") {
          alert("é ˜å–æˆåŠŸï¼");
          loadAvailableCourses();
        } else {
          alert("å¤±æ•—ï¼š" + res.message);
        }
      });
    }
  </script>
</body>
</html>
