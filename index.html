<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sherry Aerial è«‹å‡ç³»çµ±</title>
  <style>
    body { font-family: -apple-system, sans-serif; background: #f4f7f6; padding: 15px; color: #444; margin: 0; line-height: 1.6; }
    .card { background: #fff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 20px; }
    h2 { color: #2c3e50; margin-top: 0; font-size: 1.1rem; border-left: 4px solid #34495e; padding-left: 12px; margin-bottom: 20px; }
    label { font-size: 13px; color: #7f8c8d; margin-bottom: 8px; display: block; font-weight: bold; }
    
    /* ä¸‹æ‹‰é¸å–®æ¨£å¼ */
    select, button { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #dfe6e9; font-size: 16px; box-sizing: border-box; }
    
    /* æ—¥æœŸè¤‡é¸å€å¡Šæ¨£å¼ */
    .date-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 200px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 10px; border: 1px solid #eee; margin-bottom: 15px; }
    .date-item { display: flex; align-items: center; font-size: 14px; background: #fff; padding: 8px; border-radius: 6px; border: 1px solid #eee; }
    .date-item input { margin-right: 8px; }

    /* èª²ç¨‹åˆ—è¡¨æ¨£å¼ */
    .course-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #f1f2f6; }
    .course-item input { margin-right: 15px; transform: scale(1.3); accent-color: #34495e; }
    .time-label { color: #2980b9; font-weight: 600; margin-left: 8px; }
    
    button.submit-btn { background: #34495e; color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
    button.submit-btn:disabled { background: #bdc3c7; }
    .status-tag { padding: 5px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
  </style>
</head>
<body>

  <div class="card">
    <h2>ğŸ‘‹ è€å¸«è«‹å‡ç™»è¨˜</h2>
    
    <label>ç¬¬ä¸€æ­¥ï¼šé¸æ“‡æ‚¨çš„åå­—</label>
    <select id="teacherSelect"><option value="">è¼‰å…¥ä¸­...</option></select>
    
    <label id="dateLabel">ç¬¬äºŒæ­¥ï¼šå‹¾é¸è«‹å‡æ—¥æœŸ (å¯è¤‡é¸)</label>
    <div id="dateGrid" class="date-grid">è«‹å…ˆé¸æ“‡åå­—...</div>
    
    <label>ç¬¬ä¸‰æ­¥ï¼šç¢ºèªè«‹å‡èª²ç¨‹</label>
    <div id="courseList">è«‹å…ˆå‹¾é¸æ—¥æœŸ...</div>
    
    <button class="submit-btn" id="submitBtn" onclick="submitLeave()">æäº¤è«‹å‡ç”³è«‹</button>
  </div>

  <div class="card">
    <h2>ğŸ“… ä»£èª²é€²åº¦çœ‹æ¿</h2>
    <div id="board">è®€å–ä¸­...</div>
  </div>

  <script>
    const APP_URL = "https://script.google.com/macros/s/AKfycbyJADHe_DZdNIbfv_KPewAcBekEond-5Fw63i-RWCd1mHl_O9uGAQ-LTnzENZshjnhe/exec"; 
    let allCourses = []; 
    const weekDays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];

    window.onload = () => {
      fetch(`${APP_URL}?action=getTeachers`).then(r => r.json()).then(data => {
        const select = document.getElementById('teacherSelect');
        select.innerHTML = '<option value="">é»æ“Šé¸æ“‡åå­—</option>' + 
          data.map(t => `<option value="${t['æŒ‡å°è€…']}">${t['æŒ‡å°è€…']}</option>`).join('');
        select.onchange = onTeacherChange;
      });

      fetch(`${APP_URL}?action=getCourse`).then(r => r.json()).then(data => {
        allCourses = data;
      });

      renderBoard();
    };

    // æ ¼å¼åŒ–æ™‚é–“ (è™•ç† PM 2:30 é¡¯ç¤ºç‚º 14:30 çš„å•é¡Œ)
    function formatTime(timeStr) {
      if (!timeStr) return "";
      if (typeof timeStr === 'string' && timeStr.includes('T')) {
        let dateObj = new Date(timeStr);
        // å¼·åˆ¶è½‰æ›ç‚ºåœ¨åœ° 24 å°æ™‚åˆ¶æ ¼å¼
        return dateObj.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' });
      }
      return timeStr;
    }

    function onTeacherChange() {
      const name = document.getElementById('teacherSelect').value;
      const dateGrid = document.getElementById('dateGrid');
      const listDiv = document.getElementById('courseList');
      
      dateGrid.innerHTML = "";
      listDiv.innerHTML = "è«‹å…ˆå‹¾é¸æ—¥æœŸ...";
      
      if (!name) return dateGrid.innerHTML = "è«‹å…ˆé¸æ“‡åå­—...";

      // 1. ç¯©é¸è€å¸«çš„èª²ç¨‹
      const myCourses = allCourses.filter(c => c['æŒ‡å°è€…'] === name && !c['ä»£èª²è€å¸«']);
      
      // 2. å–å¾—ä¸é‡è¤‡æ—¥æœŸä¸¦æ’åº (ç”±èˆŠåˆ°æ–°)
      const sortedDates = [...new Set(myCourses.map(c => {
        let d = new Date(c['æ—¥æœŸ']);
        return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
      }))].sort((a, b) => new Date(a) - new Date(b));

      if (sortedDates.length === 0) {
        dateGrid.innerHTML = "âœ¨ ç›®å‰ç„¡å¾…è™•ç†èª²ç¨‹ã€‚";
        return;
      }

      // 3. æ¸²æŸ“æ—¥æœŸè¤‡é¸æ¡† (åŠ å…¥æ˜ŸæœŸé¡¯ç¤º)
      sortedDates.forEach(dateStr => {
        const d = new Date(dateStr);
        const dayLabel = weekDays[d.getDay()];
        dateGrid.innerHTML += `
          <label class="date-item">
            <input type="checkbox" class="date-chk" value="${dateStr}" onchange="filterCourses()">
            ${dateStr} (${dayLabel})
          </label>`;
      });
    }

    function filterCourses() {
      const name = document.getElementById('teacherSelect').value;
      const selectedDates = Array.from(document.querySelectorAll('.date-chk:checked')).map(el => el.value);
      const listDiv = document.getElementById('courseList');

      if (selectedDates.length === 0) {
        listDiv.innerHTML = "è«‹å‹¾é¸ä¸Šæ–¹æ—¥æœŸ...";
        return;
      }

      // ç¯©é¸å‡ºå‹¾é¸æ—¥æœŸå…§çš„èª²ç¨‹
      const filtered = allCourses.filter(c => {
        let d = new Date(c['æ—¥æœŸ']);
        let cDateStr = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
        return c['æŒ‡å°è€…'] === name && selectedDates.includes(cDateStr) && !c['ä»£èª²è€å¸«'];
      }).sort((a,b) => new Date(a['æ—¥æœŸ']) - new Date(b['æ—¥æœŸ'])); // èª²ç¨‹ä¹ŸæŒ‰æ™‚é–“æ’

      listDiv.innerHTML = filtered.map(c => `
        <div class="course-item">
          <input type="checkbox" class="chk" value='${JSON.stringify(c)}' checked>
          <div>
            <strong>${new Date(c['æ—¥æœŸ']).toLocaleDateString('zh-TW')} (${weekDays[new Date(c['æ—¥æœŸ']).getDay()]})</strong><br>
            <span>${c['èª²ç¨‹']}</span>
            <span class="time-label">${formatTime(c['æ™‚é–“'])}</span>
          </div>
        </div>`).join('');
    }

    function renderBoard() {
      fetch(`${APP_URL}?action=getCourse&isAdmin=true`).then(r => r.json()).then(data => {
        const items = data.filter(d => d['æŒ‡å°è€…'] !== "æŒ‡å°è€…").slice(-15).reverse();
        document.getElementById('board').innerHTML = items.map(l => {
          const d = new Date(l['æ—¥æœŸ']);
          return `
          <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #eee; align-items:center;">
            <div>
              <strong>${d.toLocaleDateString('zh-TW')} (${weekDays[d.getDay()]}) ${l['èª²ç¨‹']}</strong><br>
              <small>${formatTime(l['æ™‚é–“'])} | ${l['æŒ‡å°è€…']} è€å¸«</small>
            </div>
            <span class="status-tag" style="background:${l['ä»£èª²è€å¸«']?'#e8f5e9':'#f1f2f6'}; color:${l['ä»£èª²è€å¸«']?'#2e7d32':'#7f8c8d'};">
              ${l['ä»£èª²è€å¸«'] ? 'âœ… å·²çµæ¡ˆ' : (l['ç‹€æ…‹'] === 'è©¢å•ä¸­' ? 'âŒ› æ´½è©¢ä¸­' : 'â“ å¾µæ±‚ä¸­')}
            </span>
          </div>`;
        }).join('');
      });
    }

    function submitLeave() {
      const name = document.getElementById('teacherSelect').value;
      const selected = Array.from(document.querySelectorAll('.chk:checked')).map(el => JSON.parse(el.value));
      if (!name || selected.length === 0) return alert("è«‹å‹¾é¸è¦è«‹å‡çš„èª²ç¨‹");
      if (!confirm(`ç¢ºå®šæäº¤é€™ ${selected.length} å ‚è«‹å‡ç”³è«‹ï¼Ÿ`)) return;

      const btn = document.getElementById('submitBtn');
      btn.innerText = "æäº¤ä¸­...";
      btn.disabled = true;

      fetch(`${APP_URL}?instructor=${name}&items=${encodeURIComponent(JSON.stringify(selected))}`)
        .then(() => { alert("ç”³è«‹æˆåŠŸï¼"); location.reload(); });
    }
  </script>
</body>
</html>
