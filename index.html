<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sherry Aerial è«‹å‡ç³»çµ±</title>
  <style>
    body { font-family: -apple-system, sans-serif; background: #f4f7f6; padding: 15px; color: #444; margin: 0; line-height: 1.6; }
    .card { background: #fff; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 20px; }
    h2 { color: #2c3e50; margin-top: 0; font-size: 1.1rem; border-left: 4px solid #34495e; padding-left: 12px; margin-bottom: 20px; }
    label { font-size: 13px; color: #7f8c8d; margin-bottom: 5px; display: block; }
    select, button { width: 100%; padding: 12px; margin: 8px 0 15px 0; border-radius: 10px; border: 1px solid #dfe6e9; font-size: 16px; box-sizing: border-box; -webkit-appearance: none; }
    select { background: #fff url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E") no-repeat right 12px center; background-size: 12px; }
    button.submit-btn { background: #34495e; color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; }
    button.submit-btn:disabled { background: #bdc3c7; }
    .course-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #f1f2f6; }
    .course-item input { margin-right: 15px; transform: scale(1.3); accent-color: #34495e; }
    .time-label { color: #2980b9; font-weight: 600; margin-left: 5px; }
    .status-tag { padding: 5px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
    #courseList { min-height: 40px; }
  </style>
</head>
<body>

  <div class="card">
    <h2>ğŸ‘‹ è€å¸«è«‹å‡ç™»è¨˜</h2>
    
    <label>Step 1. é¸æ“‡æ‚¨çš„åå­—</label>
    <select id="teacherSelect"><option value="">è¼‰å…¥ä¸­...</option></select>
    
    <label>Step 2. é¸æ“‡æ—¥æœŸ</label>
    <select id="dateSelect" disabled><option value="">è«‹å…ˆé¸æ“‡åå­—</option></select>
    
    <label>Step 3. å‹¾é¸èª²ç¨‹</label>
    <div id="courseList">è«‹å®Œæˆä¸Šæ–¹é¸æ“‡...</div>
    
    <button class="submit-btn" id="submitBtn" onclick="submitLeave()">æäº¤è«‹å‡ç”³è«‹</button>
  </div>

  <div class="card">
    <h2>ğŸ“… ä»£èª²é€²åº¦çœ‹æ¿</h2>
    <div id="board">è®€å–ä¸­...</div>
  </div>

  <script>
    const APP_URL = "https://script.google.com/macros/s/AKfycbyJADHe_DZdNIbfv_KPewAcBekEond-5Fw63i-RWCd1mHl_O9uGAQ-LTnzENZshjnhe/exec"; 
    let allCourses = []; 

    window.onload = () => {
      fetch(`${APP_URL}?action=getTeachers`).then(r => r.json()).then(data => {
        const select = document.getElementById('teacherSelect');
        select.innerHTML = '<option value="">é»æ“Šé¸æ“‡åå­—</option>' + 
          data.map(t => `<option value="${t['æŒ‡å°è€…']}">${t['æŒ‡å°è€…']}</option>`).join('');
        select.onchange = onTeacherChange;
      });

      fetch(`${APP_URL}?action=getCourse`).then(r => r.json()).then(data => {
        allCourses = data;
      });

      renderBoard();
    };

    // æ ¼å¼åŒ–æ™‚é–“ (ä¿®æ­£ PM å•é¡Œ)
    function formatTime(timeStr) {
      if (!timeStr) return "";
      if (typeof timeStr === 'string' && timeStr.includes('T')) {
        let t = timeStr.split('T')[1].substring(0, 5);
        // å¦‚æœå¦³çš„ Excel å‡ºç¾ 12 å°æ™‚åˆ¶ï¼Œé€™è£¡å¯ä»¥é€²ä¸€æ­¥è™•ç†ï¼Œ
        // ä½†é€šå¸¸ ISO æ ¼å¼ (Tä¹‹å¾Œ) æ˜¯ 24 å°æ™‚åˆ¶ã€‚
        return t; 
      }
      return timeStr;
    }

    function onTeacherChange() {
      const name = document.getElementById('teacherSelect').value;
      const dateSelect = document.getElementById('dateSelect');
      const listDiv = document.getElementById('courseList');
      
      dateSelect.innerHTML = '<option value="">é¸æ“‡æ—¥æœŸ</option>';
      listDiv.innerHTML = "è«‹é¸æ“‡æ—¥æœŸ...";
      
      if (!name) {
        dateSelect.disabled = true;
        return;
      }

      // æ‰¾å‡ºè©²è€å¸«æœ‰å“ªäº›æ—¥æœŸæœ‰èª²
      const myDates = [...new Set(allCourses
        .filter(c => c['æŒ‡å°è€…'] === name && !c['ä»£èª²è€å¸«'])
        .map(c => new Date(c['æ—¥æœŸ']).toLocaleDateString('zh-TW'))
      )].sort();

      if (myDates.length === 0) {
        dateSelect.innerHTML = '<option value="">ç›®å‰ç„¡èª²ç¨‹</option>';
        dateSelect.disabled = true;
        listDiv.innerHTML = "âœ¨ æ‚¨ç›®å‰æ²’æœ‰å¾…è™•ç†çš„èª²ç¨‹ã€‚";
      } else {
        dateSelect.disabled = false;
        myDates.forEach(d => {
          dateSelect.innerHTML += `<option value="${d}">${d}</option>`;
        });
        dateSelect.onchange = filterCourses;
      }
    }

    function filterCourses() {
      const name = document.getElementById('teacherSelect').value;
      const date = document.getElementById('dateSelect').value;
      const listDiv = document.getElementById('courseList');

      if (!date) {
        listDiv.innerHTML = "è«‹é¸æ“‡æ—¥æœŸ...";
        return;
      }

      const filtered = allCourses.filter(c => 
        c['æŒ‡å°è€…'] === name && 
        new Date(c['æ—¥æœŸ']).toLocaleDateString('zh-TW') === date &&
        !c['ä»£èª²è€å¸«']
      );

      listDiv.innerHTML = filtered.map(c => `
        <div class="course-item">
          <input type="checkbox" class="chk" value='${JSON.stringify(c)}'>
          <div>
            <strong>${c['èª²ç¨‹']}</strong>
            <span class="time-label">${formatTime(c['æ™‚é–“'])}</span>
          </div>
        </div>`).join('');
    }

    function renderBoard() {
      fetch(`${APP_URL}?action=getCourse&isAdmin=true`).then(r => r.json()).then(data => {
        const items = data.filter(d => d['æŒ‡å°è€…'] !== "æŒ‡å°è€…").slice(-15).reverse();
        document.getElementById('board').innerHTML = items.map(l => `
          <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #eee; align-items:center;">
            <div>
              <strong>${new Date(l['æ—¥æœŸ']).toLocaleDateString('zh-TW')} ${l['èª²ç¨‹']}</strong><br>
              <small>${formatTime(l['æ™‚é–“'])} | ${l['æŒ‡å°è€…']} è€å¸«</small>
            </div>
            <span class="status-tag" style="background:${l['ä»£èª²è€å¸«']?'#e8f5e9':'#f1f2f6'}; color:${l['ä»£èª²è€å¸«']?'#2e7d32':'#7f8c8d'};">
              ${l['ä»£èª²è€å¸«'] ? 'âœ… å·²çµæ¡ˆ' : (l['ç‹€æ…‹'] === 'è©¢å•ä¸­' ? 'âŒ› æ´½è©¢ä¸­' : 'â“ å¾µæ±‚ä¸­')}
            </span>
          </div>`).join('');
      });
    }

    function submitLeave() {
      const name = document.getElementById('teacherSelect').value;
      const selected = Array.from(document.querySelectorAll('.chk:checked')).map(el => JSON.parse(el.value));
      if (!name || selected.length === 0) return alert("è«‹å‹¾é¸èª²ç¨‹");
      if (!confirm(`ç¢ºå®šæäº¤é€™ ${selected.length} å ‚è«‹å‡ç”³è«‹ï¼Ÿ`)) return;

      const btn = document.getElementById('submitBtn');
      btn.innerText = "æäº¤ä¸­...";
      btn.disabled = true;

      fetch(`${APP_URL}?instructor=${name}&items=${encodeURIComponent(JSON.stringify(selected))}`)
        .then(() => { alert("ç”³è«‹æˆåŠŸï¼"); location.reload(); });
    }
  </script>
</body>
</html>
