<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sherry Aerial è«‹å‡ç³»çµ±</title>
  <style>
    body { font-family: -apple-system, sans-serif; background: #f8f9fa; padding: 15px; color: #333; margin: 0; }
    .card { background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
    h2 { color: #455a64; margin-top: 0; font-size: 1.2rem; border-left: 5px solid #455a64; padding-left: 10px; }
    select, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; box-sizing: border-box; }
    button.submit-btn { background: #455a64; color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 20px; }
    button.submit-btn:active { opacity: 0.8; transform: scale(0.98); }
    .course-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
    .course-item input { margin-right: 15px; transform: scale(1.4); cursor: pointer; }
    .status-tag { padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; white-space: nowrap; }
    #courseList { min-height: 50px; color: #666; font-size: 14px; }
    .time-label { color: #d32f2f; font-weight: bold; margin-left: 8px; }
  </style>
</head>
<body>

  <div class="card">
    <h2>ğŸ‘‹ è€å¸«è«‹å‡ç™»è¨˜</h2>
    <label for="teacherSelect" style="font-size: 14px; color: #666;">ç¬¬ä¸€æ­¥ï¼šè«‹å…ˆé¸æ“‡æ‚¨çš„åå­—</label>
    <select id="teacherSelect">
      <option value="">è¼‰å…¥åå–®ä¸­...</option>
    </select>
    
    <label style="font-size: 14px; color: #666; margin-top: 10px; display: block;">ç¬¬äºŒæ­¥ï¼šå‹¾é¸è¦è«‹å‡çš„èª²ç¨‹</label>
    <div id="courseList">è«‹å…ˆé¸æ“‡åå­—ä»¥è¼‰å…¥èª²ç¨‹...</div>
    
    <button class="submit-btn" onclick="submitLeave()">æäº¤è«‹å‡ç”³è«‹</button>
  </div>

  <div class="card">
    <h2>ğŸ“… ä»£èª²é€²åº¦çœ‹æ¿ (æœ€è¿‘15ç­†)</h2>
    <div id="board">è®€å–ä¸­...</div>
  </div>

  <script>
    const APP_URL = "https://script.google.com/macros/s/AKfycbyJADHe_DZdNIbfv_KPewAcBekEond-5Fw63i-RWCd1mHl_O9uGAQ-LTnzENZshjnhe/exec"; 
    let allCourses = []; 

    window.onload = () => {
      // 1. è¼‰å…¥è€å¸«åå–®
      fetch(`${APP_URL}?action=getTeachers`)
        .then(r => r.json())
        .then(data => {
          const select = document.getElementById('teacherSelect');
          select.innerHTML = '<option value="">è«‹é¸æ“‡æ‚¨çš„åå­—</option>' + 
            data.map(t => `<option value="${t['æŒ‡å°è€…']}">${t['æŒ‡å°è€…']}</option>`).join('');
          
          // ç›£è½åå­—è®Šå‹•
          select.onchange = filterCourses;
        });

      // 2. é æŠ“æ‰€æœ‰èª²ç¨‹è³‡æ–™
      fetch(`${APP_URL}?action=getCourse`)
        .then(r => r.json())
        .then(data => {
          allCourses = data;
        });

      // 3. æ¸²æŸ“çœ‹æ¿
      renderBoard();
    };

    // æ ¼å¼åŒ–æ™‚é–“ï¼Œè§£æ±º 1899-12-30T... çš„å•é¡Œ
    function formatTime(timeStr) {
      if (!timeStr) return "";
      if (typeof timeStr === 'string' && timeStr.includes('T')) {
        return timeStr.split('T')[1].substring(0, 5);
      }
      return timeStr;
    }

    // æ ¹æ“šé¸æ“‡çš„è€å¸«éæ¿¾èª²ç¨‹
    function filterCourses() {
      const selectedTeacher = document.getElementById('teacherSelect').value;
      const listDiv = document.getElementById('courseList');
      
      if (!selectedTeacher) {
        listDiv.innerHTML = "è«‹å…ˆé¸æ“‡åå­—ä»¥è¼‰å…¥èª²ç¨‹...";
        return;
      }

      // ç¯©é¸ï¼šæŒ‡å°è€…ç›¸ç¬¦ï¼Œä¸”ç›®å‰æ²’æœ‰ä»£èª²è€å¸«ï¼ˆä»£è¡¨å°šæœªçµæ¡ˆï¼‰
      const myCourses = allCourses.filter(c => c['æŒ‡å°è€…'] === selectedTeacher && !c['ä»£èª²è€å¸«']);

      if (myCourses.length === 0) {
        listDiv.innerHTML = "âœ¨ ç›®å‰æ²’æœ‰æ‚¨çš„å¾…è™•ç†èª²ç¨‹ã€‚";
        return;
      }

      listDiv.innerHTML = myCourses.map(c => `
        <div class="course-item">
          <input type="checkbox" class="chk" value='${JSON.stringify(c)}'>
          <div>
            <strong>${new Date(c['æ—¥æœŸ']).toLocaleDateString('zh-TW')}</strong> 
            <span class="time-label">${formatTime(c['æ™‚é–“'])}</span><br>
            <small>${c['èª²ç¨‹']}</small>
          </div>
        </div>`).join('');
    }

    // æ¸²æŸ“é€²åº¦çœ‹æ¿
    function renderBoard() {
      fetch(`${APP_URL}?action=getCourse&isAdmin=true`)
        .then(r => r.json())
        .then(data => {
          // éæ¿¾æ‰æ¨™é¡Œåˆ—ï¼Œå–å‡ºæœ€è¿‘ 15 ç­†ä¸¦åè½‰ï¼ˆæ–°çš„åœ¨å‰ï¼‰
          const items = data.filter(d => d['æŒ‡å°è€…'] !== "æŒ‡å°è€…").slice(-15).reverse();
          document.getElementById('board').innerHTML = items.map(l => `
            <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #eee; align-items:center;">
              <div>
                <strong>${new Date(l['æ—¥æœŸ']).toLocaleDateString('zh-TW')} ${l['èª²ç¨‹']}</strong><br>
                <small>${formatTime(l['æ™‚é–“'])} | ${l['æŒ‡å°è€…']} è€å¸«</small>
              </div>
              <span class="status-tag" style="background:${l['ä»£èª²è€å¸«']?'#e8f5e9':'#fff3e0'}; color:${l['ä»£èª²è€å¸«']?'#2e7d32':'#ef6c00'};">
                ${l['ä»£èª²è€å¸«'] ? 'âœ… å·²çµæ¡ˆ' : (l['ç‹€æ…‹'] === 'è©¢å•ä¸­' ? 'â³ æ´½è©¢ä¸­' : 'â“ å¾µæ±‚ä¸­')}
              </span>
            </div>`).join('');
        });
    }

    // æäº¤è«‹å‡
    function submitLeave() {
      const name = document.getElementById('teacherSelect').value;
      const selected = Array.from(document.querySelectorAll('.chk:checked')).map(el => JSON.parse(el.value));
      
      if (!name) return alert("è«‹å…ˆé¸æ“‡æ‚¨çš„åå­—");
      if (selected.length === 0) return alert("è«‹è‡³å°‘å‹¾é¸ä¸€å ‚æ¬²è«‹å‡çš„èª²ç¨‹");
      
      if (!confirm(`ç¢ºå®šè¦ç‚ºé€™ ${selected.length} å ‚èª²ç¨‹ç”³è«‹è«‹å‡å—ï¼Ÿ`)) return;

      // é¡¯ç¤ºè™•ç†ä¸­ï¼ˆæš«æ™‚åœç”¨æŒ‰éˆ•ï¼‰
      const btn = document.querySelector('.submit-btn');
      btn.innerText = "æäº¤ä¸­...";
      btn.disabled = true;

      fetch(`${APP_URL}?instructor=${name}&items=${encodeURIComponent(JSON.stringify(selected))}`)
        .then(() => { 
          alert("ç”³è«‹æˆåŠŸï¼ç³»çµ±å·²é€šçŸ¥ Sherry ä¸¦æ›´æ–°çœ‹æ¿ã€‚"); 
          location.reload(); 
        })
        .catch(err => {
          alert("æäº¤å¤±æ•—ï¼Œè«‹è¯ç¹« Sherry");
          btn.innerText = "æäº¤è«‹å‡ç”³è«‹";
          btn.disabled = false;
        });
    }
  </script>
</body>
</html>
