<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sherry å¾Œå°èª¿åº¦</title>
  <style>
    body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 15px; }
    .header { position: sticky; top: 0; background: #f0f2f5; z-index: 100; padding: 10px 0; border-bottom: 1px solid #ddd; }
    .card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
    .chk-box { position: absolute; left: 15px; top: 18px; transform: scale(1.5); }
    .course-info { margin-left: 40px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
    .btn { padding: 10px; border-radius: 6px; text-align: center; font-size: 13px; font-weight: bold; color: white; border: none; cursor: pointer; }
    .t1 { background: #ff9800; } .t2 { background: #03a9f4; } .t3 { background: #90a4ae; }
    .other-skill { background: #fff; color: #bbb; border: 1px dashed #ddd; }
    .status-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #eee; }
  </style>
</head>
<body>
  <div class="header">
    <h2>ğŸ’ Sherry èª¿åº¦ä¸­å¿ƒ</h2>
    <small>å‹¾é¸å·¦å´èª²ç¨‹ â†’ é»é¸è€å¸«å (è‡ªå‹•è¨˜éŒ„ä¸¦è¤‡è£½é€£çµ)</small>
  </div>
  <div id="main" style="margin-top:20px;">è®€å–ä¸­...</div>

  <script>
    const APP_URL = "https://script.google.com/macros/s/AKfycbyJADHe_DZdNIbfv_KPewAcBekEond-5Fw63i-RWCd1mHl_O9uGAQ-LTnzENZshjnhe/exec"; 
    let teachers = [], courses = [];

    window.onload = () => {
      Promise.all([
        fetch(`${APP_URL}?action=getCourse&isAdmin=true`).then(r=>r.json()), 
        fetch(`${APP_URL}?action=getTeachers`).then(r=>r.json())
      ]).then(([cData, tData]) => {
        courses = cData.filter(d => d['æŒ‡å°è€…'] !== "æŒ‡å°è€…" && !d['ä»£èª²è€å¸«']);
        teachers = tData;
        render();
      });
    };

    function render() {
      const main = document.getElementById('main');
      if(courses.length===0) { main.innerHTML='<div style="text-align:center; padding:50px;">æš«ç„¡å¾…è™•ç†è«‹å‡</div>'; return; }
      
      main.innerHTML = courses.map(c => {
        let type = c['èª²ç¨‹'].includes('ç©ºç‘œ') ? 'ç©ºç‘œ' : (c['èª²ç¨‹'].includes('ç©ºç’°') ? 'ç©ºç’°' : (c['èª²ç¨‹'].includes('èˆç¶¢') ? 'èˆç¶¢' : 'å…¶ä»–'));
        const sortedT = [...teachers].sort((a,b) => (b['å°ˆé•·'].includes(type) || b['å°ˆé•·'].includes('å…¨èƒ½')) - (a['å°ˆé•·'].includes(type) || a['å°ˆé•·'].includes('å…¨èƒ½')));

        return `
          <div class="card">
            <input type="checkbox" class="course-chk chk-box" value="${c.rowId}">
            <div class="course-info">
              <strong>${new Date(c['æ—¥æœŸ']).toLocaleDateString('zh-TW')} ${c['æ™‚é–“']}</strong> 
              <span class="status-badge">${c['ç‹€æ…‹'] || 'å¾µæ±‚ä¸­'}</span><br>
              ${c['èª²ç¨‹']} (åŸå¸«ï¼š${c['æŒ‡å°è€…']})
              ${c['æœ€å¾Œè©¢å•å°è±¡'] ? `<br><small style="color:blue">æœ€å¾Œè©¢å•ï¼š${c['æœ€å¾Œè©¢å•å°è±¡']}</small>` : ''}
            </div>
            <div class="grid">${sortedT.map(t => {
              const isMatch = t['å°ˆé•·'].includes(type) || t['å°ˆé•·'].includes('å…¨èƒ½');
              return `<button class="btn ${isMatch ? t['æ¢¯æ¬¡'] : 'other-skill'}" onclick="generateLink('${t['æŒ‡å°è€…']}')">
                ${isMatch ? '' : '(è·¨)'}${t['æŒ‡å°è€…']}</button>`;
            }).join('')}</div>
          </div>`;
      }).join('');
    }

    function generateLink(tName) {
      const selectedIds = Array.from(document.querySelectorAll('.course-chk:checked')).map(el => el.value);
      if (selectedIds.length === 0) return alert("è«‹å…ˆå‹¾é¸èª²ç¨‹ï¼");
      
      const subUrl = window.location.href.replace('admin.html', 'sub.html');
      const finalUrl = `${subUrl}?name=${encodeURIComponent(tName)}&ids=${selectedIds.join(',')}`;
      
      // è¨˜éŒ„è©¢å•ç‹€æ…‹
      Promise.all(selectedIds.map(id => 
        fetch(`${APP_URL}?action=updateStatus&rowId=${id}&status=è©¢å•ä¸­&lastTeacher=${encodeURIComponent(tName)}`)
      )).then(() => {
        const msg = `è€å¸«æ‚¨å¥½ï¼Œæƒ³è«‹å•é€™å¹¾å ‚èª²æ‚¨æ–¹ä¾¿ä»£èª²å—ï¼Ÿ\né»æ“Šé€£çµæŸ¥çœ‹ä¸¦å›è¦†ï¼š\n${finalUrl}`;
        navigator.clipboard.writeText(msg).then(() => {
          alert(`å·²æ¨™è¨˜ç‚ºè©¢å• ${tName} ä¸­ï¼é€£çµå·²è¤‡è£½ï¼Œè«‹è‡³ LINE è²¼ä¸Šã€‚`);
          location.reload();
        });
      });
    }
  </script>
</body>
</html>
