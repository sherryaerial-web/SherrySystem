<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sherry å¾Œå°èª¿åº¦ä¸­å¿ƒ</title>
  <style>
    body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 15px; margin: 0; }
    .header { position: sticky; top: 0; background: #f0f2f5; z-index: 100; padding: 10px 0; border-bottom: 1px solid #ddd; margin-bottom: 15px; }
    .card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
    .chk-box { position: absolute; left: 15px; top: 18px; transform: scale(1.5); cursor: pointer; }
    .course-info { margin-left: 45px; }
    .status-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #e0e0e0; color: #666; font-weight: bold; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
    .btn { padding: 12px 5px; border-radius: 8px; text-align: center; font-size: 13px; font-weight: bold; color: white; border: none; cursor: pointer; transition: 0.2s; }
    .btn:active { transform: scale(0.95); opacity: 0.8; }
    
    /* æ¢¯æ¬¡é¡è‰²è¨­å®š */
    .t1 { background: #ff9800; box-shadow: 0 2px 4px rgba(255,152,0,0.3); } /* æ©˜è‰² */
    .t2 { background: #03a9f4; box-shadow: 0 2px 4px rgba(3,169,244,0.3); } /* è—è‰² */
    .t3 { background: #90a4ae; box-shadow: 0 2px 4px rgba(144,164,174,0.3); } /* ç°è‰² */
    .other-skill { background: #ffffff; color: #bbb; border: 1px dashed #ddd; } /* è·¨ç•Œ/ä¸ç¬¦ */
    
    .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; align-items:center; justify-content:center; z-index:999; }
  </style>
</head>
<body>
  <div id="loader" class="loading-overlay">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>

  <div class="header">
    <h2 style="margin:0">ğŸ’ Sherry èª¿åº¦ä¸­å¿ƒ</h2>
    <small style="color:#666">1. å‹¾é¸å·¦å´èª²ç¨‹ â†’ 2. é»æ“Šè€å¸«å (è‡ªå‹•ç”¢é€£çµ+ç´€éŒ„)</small>
  </div>

  <div id="main">è®€å–èª²ç¨‹è³‡æ–™ä¸­...</div>

  <script>
    const APP_URL = "https://script.google.com/macros/s/AKfycbyJADHe_DZdNIbfv_KPewAcBekEond-5Fw63i-RWCd1mHl_O9uGAQ-LTnzENZshjnhe/exec"; 
    let teachers = [], courses = [];

    window.onload = () => {
      fetchData();
    };

    function fetchData() {
      Promise.all([
        fetch(`${APP_URL}?action=getCourse&isAdmin=true`).then(r=>r.json()), 
        fetch(`${APP_URL}?action=getTeachers`).then(r=>r.json())
      ]).then(([cData, tData]) => {
        // éæ¿¾æ‰æ¨™é¡Œåˆ—ï¼Œä¸”åªé¡¯ç¤ºé‚„æ²’æˆäº¤çš„èª²
        courses = cData.filter(d => d['æŒ‡å°è€…'] !== "æŒ‡å°è€…" && !d['ä»£èª²è€å¸«']);
        teachers = tData;
        render();
      }).catch(err => {
        document.getElementById('main').innerHTML = "è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– GAS ç¶²å€ã€‚";
      });
    }

    function render() {
      const main = document.getElementById('main');
      if(courses.length === 0) { 
        main.innerHTML = '<div style="text-align:center; padding:50px; color:#999;">ğŸ‰ ç›®å‰æ²’æœ‰å¾…è™•ç†çš„è«‹å‡ç”³è«‹</div>'; 
        return; 
      }
      
      main.innerHTML = courses.map(c => {
        // è‡ªå‹•åˆ¤æ–·èª²ç¨‹é¡å‹
        let type = "å…¶ä»–";
        if (c['èª²ç¨‹'].includes('ç©ºç‘œ')) type = 'ç©ºç‘œ';
        else if (c['èª²ç¨‹'].includes('ç©ºç’°')) type = 'ç©ºç’°';
        else if (c['èª²ç¨‹'].includes('èˆç¶¢')) type = 'èˆç¶¢';

        // æ™ºæ…§æ’åºï¼šå…¨èƒ½å„ªå…ˆæ–¼å–®é …ï¼Œä¸”æ•¸å­—è¶Šå°è¶Šå‰é¢
        const sortedT = [...teachers].sort((a, b) => {
          const getScore = (t) => {
            const skills = t['å°ˆé•·'] ? t['å°ˆé•·'].split(',').map(s => s.trim()) : [];
            let score = 999;
            skills.forEach(s => {
              const rank = parseInt(s.replace(/[^0-9]/g, '')) || 1;
              if (s.includes('å…¨èƒ½')) {
                if (rank < score) score = rank; // å…¨èƒ½åˆ†æ•¸ï¼š1, 2, 3...
              } else if (s.includes(type)) {
                const itemScore = rank + 100; // å–®é …åˆ†æ•¸ï¼š101, 102... (ç¢ºä¿æ’åœ¨å…¨èƒ½å¾Œ)
                if (itemScore < score) score = itemScore;
              }
            });
            return score;
          };
          return getScore(a) - getScore(b);
        });

        return `
          <div class="card">
            <input type="checkbox" class="course-chk chk-box" value="${c.rowId}">
            <div class="course-info">
              <strong>${new Date(c['æ—¥æœŸ']).toLocaleDateString('zh-TW')} ${c['æ™‚é–“']}</strong> 
              <span class="status-badge" style="background:${c['ç‹€æ…‹']==='è©¢å•ä¸­'?'#fff9c4':'#eee'}">${c['ç‹€æ…‹'] || 'å¾µæ±‚ä¸­'}</span><br>
              <span style="font-size:1.1rem; color:#333;">${c['èª²ç¨‹']}</span> <small>(åŸå¸«ï¼š${c['æŒ‡å°è€…']})</small>
              ${c['æœ€å¾Œè©¢å•å°è±¡'] ? `<br><small style="color:#1976d2">ğŸ“ æœ€å¾Œè©¢å•ï¼š${c['æœ€å¾Œè©¢å•å°è±¡']}</small>` : ''}
            </div>
            <div class="grid">${sortedT.map(t => {
              const isMatch = (t['å°ˆé•·']||'').includes(type) || (t['å°ˆé•·']||'').includes('å…¨èƒ½');
              return `<button class="btn ${isMatch ? (t['æ¢¯æ¬¡']||'t3') : 'other-skill'}" 
                      onclick="generateLink('${t['æŒ‡å°è€…']}')">${t['æŒ‡å°è€…']}</button>`;
            }).join('')}</div>
          </div>`;
      }).join('');
    }

    function generateLink(tName) {
      const selectedIds = Array.from(document.querySelectorAll('.course-chk:checked')).map(el => el.value);
      if (selectedIds.length === 0) return alert("è«‹å…ˆå‹¾é¸å·¦å´è¦è©¢å•çš„èª²ç¨‹ï¼");
      
      document.getElementById('loader').style.display = 'flex';
      
      const subUrl = window.location.href.replace('admin.html', 'sub.html');
      const finalUrl = `${subUrl}?name=${encodeURIComponent(tName)}&ids=${selectedIds.join(',')}`;
      
      // æ›´æ–° Excel ç‹€æ…‹ç‚ºã€Œè©¢å•ä¸­ã€ä¸¦è¨˜éŒ„å°è±¡
      Promise.all(selectedIds.map(id => 
        fetch(`${APP_URL}?action=updateStatus&rowId=${id}&status=è©¢å•ä¸­&lastTeacher=${encodeURIComponent(tName)}`)
      )).then(() => {
        const msg = `è€å¸«æ‚¨å¥½ï¼Œæƒ³è«‹å•é€™å¹¾å ‚èª²æ‚¨æ–¹ä¾¿ä»£èª²å—ï¼Ÿ\né»æ“Šé€£çµæŸ¥çœ‹ä¸¦å›è¦†ï¼š\n${finalUrl}`;
        
        navigator.clipboard.writeText(msg).then(() => {
          document.getElementById('loader').style.display = 'none';
          alert(`âœ… å·²è¨˜éŒ„ç‚ºè©¢å• ${tName} ä¸­ï¼\n\né‚€ç´„è¨Šæ¯å·²è¤‡è£½ï¼Œè«‹ç›´æ¥åˆ° LINE è²¼ä¸Šå‚³é€ã€‚`);
          fetchData(); // é‡æ–°æ•´ç†ç•«é¢é¡¯ç¤ºæœ€æ–°ç‹€æ…‹
        });
      }).catch(err => {
        alert("æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ GAS æ¬Šé™");
        document.getElementById('loader').style.display = 'none';
      });
    }
  </script>
</body>
</html>
