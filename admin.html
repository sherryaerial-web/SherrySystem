<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sherry å¾Œå°èª¿åº¦ä¸­å¿ƒ</title>
  <style>
    body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 15px; }
    .card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
    .course-info { margin-left: 35px; }
    .chk-box { position: absolute; left: 15px; top: 18px; transform: scale(1.5); }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 15px 0 10px 0; }
    .btn { padding: 10px; border-radius: 6px; text-decoration: none; text-align: center; font-size: 13px; font-weight: bold; color: white; cursor: pointer; border: none; }
    .t1 { background: #ff9800; } .t2 { background: #03a9f4; } .t3 { background: #90a4ae; }
    .other-skill { background: #fff; color: #bbb; border: 1px dashed #ddd; }
    .header-bar { position: sticky; top: 0; background: #f0f2f5; padding: 10px 0; z-index: 100; border-bottom: 1px solid #ddd; margin-bottom: 15px; }
    .status-hint { font-size: 12px; color: #666; margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="header-bar">
    <h2>ğŸ’ Sherry èª¿åº¦ä¸­å¿ƒ</h2>
    <p class="status-hint">æ­¥é©Ÿï¼š1.å‹¾é¸å·¦å´èª²ç¨‹ -> 2.é»æ“Šä¸‹æ–¹è€å¸«åå­— (è‡ªå‹•ç”¢ç”Ÿé‚€ç´„é€£çµ)</p>
  </div>
  
  <div id="main">è®€å–ä¸­...</div>

  <script>
    const APP_URL = "å¦³çš„GASç¶²å€"; 
    let teachers = []; let courses = [];

    window.onload = () => {
      Promise.all([
        fetch(`${APP_URL}?action=getCourse&isAdmin=true`).then(r=>r.json()), 
        fetch(`${APP_URL}?action=getTeachers`).then(r=>r.json())
      ]).then(([cData, tData]) => {
        courses = cData.filter(d => d['æŒ‡å°è€…'] !== "æŒ‡å°è€…" && !d['ä»£èª²è€å¸«']);
        teachers = tData;
        render();
      });
    };

    function render() {
      const main = document.getElementById('main');
      if(courses.length===0) { main.innerHTML='<div style="text-align:center; padding:50px;">ç›®å‰æ²’æœ‰å¾…è™•ç†ç”³è«‹</div>'; return; }
      
      main.innerHTML = courses.map((c, i) => {
        let type = "å…¶ä»–"; 
        if (c['èª²ç¨‹'].includes('ç©ºç‘œ')) type = 'ç©ºç‘œ';
        else if (c['èª²ç¨‹'].includes('ç©ºç’°')) type = 'ç©ºç’°';
        else if (c['èª²ç¨‹'].includes('èˆç¶¢')) type = 'èˆç¶¢';

        // ä¾å°ˆé•·èˆ‡æ¢¯æ¬¡æ’åºè€å¸«
        const sortedT = [...teachers].sort((a,b) => {
          const am = a['å°ˆé•·'].includes(type) || a['å°ˆé•·'].includes('å…¨èƒ½');
          const bm = b['å°ˆé•·'].includes(type) || b['å°ˆé•·'].includes('å…¨èƒ½');
          return bm - am;
        });

        return `
          <div class="card">
            <input type="checkbox" class="course-chk chk-box" value="${c.rowId}">
            <div class="course-info">
              <strong>${new Date(c['æ—¥æœŸ']).toLocaleDateString()} ${c['æ™‚é–“']}</strong><br>
              ${c['èª²ç¨‹']} (åŸå¸«ï¼š${c['æŒ‡å°è€…']})
            </div>
            <div class="grid">${sortedT.map(t => {
              const isMatch = t['å°ˆé•·'].includes(type) || t['å°ˆé•·'].includes('å…¨èƒ½');
              return `<button class="btn ${isMatch ? t['æ¢¯æ¬¡'] : 'other-skill'}" 
                      onclick="generateLink('${t['æŒ‡å°è€…']}')">${isMatch ? '' : '(è·¨)'}${t['æŒ‡å°è€…']}</button>`;
            }).join('')}</div>
          </div>`;
      }).join('');
    }

    function generateLink(tName) {
      const selectedIds = Array.from(document.querySelectorAll('.course-chk:checked')).map(el => el.value);
      if (selectedIds.length === 0) return alert("è«‹å…ˆå‹¾é¸æƒ³è¦è«‹é€™ä½è€å¸«ä»£çš„èª²ç¨‹ï¼");
      
      // ç”¢å‡º sub.html çš„ç¶²å€
      const subUrl = window.location.href.replace('admin.html', 'sub.html');
      const finalUrl = `${subUrl}?name=${encodeURIComponent(tName)}&ids=${selectedIds.join(',')}`;
      
      const msg = `è€å¸«æ‚¨å¥½ï¼Œæƒ³è«‹å•é€™å¹¾å ‚èª²æ‚¨æ–¹ä¾¿ä»£èª²å—ï¼Ÿ\né»æ“Šé€£çµæŸ¥çœ‹ä¸¦å›è¦†ï¼š\n${finalUrl}`;
      
      // è¤‡è£½åˆ°å‰ªè²¼ç°¿
      navigator.clipboard.writeText(msg).then(() => {
        alert(`å·²å‹¾é¸ ${selectedIds.length} å ‚èª²ï¼\nå·²ç‚º ${tName} è€å¸«ç”¢ç”Ÿå°ˆå±¬é€£çµä¸¦è¤‡è£½å¥½å›‰ï¼Œç›´æ¥å» LINE è²¼ä¸Šå³å¯ï¼`);
      });
    }
  </script>
</body>
</html>
