<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sherry å¾Œå°èª¿åº¦</title>
  <style>
    body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 15px; margin: 0; }
    .header { position: sticky; top: 0; background: #f0f2f5; z-index: 100; padding: 10px 0; border-bottom: 1px solid #ddd; }
    .card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
    .chk-box { position: absolute; left: 15px; top: 18px; transform: scale(1.5); }
    .course-info { margin-left: 45px; }
    .status-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #eee; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
    .btn { padding: 12px 5px; border-radius: 8px; text-align: center; font-size: 13px; font-weight: bold; color: white; border: none; cursor: pointer; }
    .t1 { background: #ff9800; } .t2 { background: #03a9f4; } .t3 { background: #90a4ae; }
    .other-skill { background: #fff; color: #bbb; border: 1px dashed #ddd; }
    .loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; align-items:center; justify-content:center; z-index:999; }
  </style>
</head>
<body>
  <div id="loader" class="loading">è™•ç†ä¸­...</div>
  <div class="header"><h2>ğŸ’ Sherry èª¿åº¦ä¸­å¿ƒ</h2><small>å‹¾é¸èª²ç¨‹ â†’ é»é¸è€å¸« (è‡ªå‹•è¨˜éŒ„ä¸¦è¤‡è£½é€£çµ)</small></div>
  <div id="main" style="margin-top:20px;">è®€å–ä¸­...</div>
  <script>
    const APP_URL = "https://script.google.com/macros/s/AKfycbyJADHe_DZdNIbfv_KPewAcBekEond-5Fw63i-RWCd1mHl_O9uGAQ-LTnzENZshjnhe/exec"; 
    let teachers = [], courses = [];
    window.onload = () => fetchData();
    function fetchData() {
      Promise.all([
        fetch(`${APP_URL}?action=getCourse&isAdmin=true`).then(r=>r.json()), 
        fetch(`${APP_URL}?action=getTeachers`).then(r=>r.json())
      ]).then(([cData, tData]) => {
        courses = cData.filter(d => d['æŒ‡å°è€…'] !== "æŒ‡å°è€…" && !d['ä»£èª²è€å¸«']);
        teachers = tData;
        render();
      });
    }
    function render() {
      const main = document.getElementById('main');
      if(courses.length===0) { main.innerHTML='<div style="text-align:center; padding:50px;">æš«ç„¡å¾…è™•ç†è«‹å‡</div>'; return; }
      main.innerHTML = courses.map(c => {
        // ç´”æ•¸å­—æ’åºé‚è¼¯ (1è™Ÿæ’æœ€å‰é¢)
        const sortedT = [...teachers].sort((a,b) => (parseInt(a['å°ˆé•·'])||99) - (parseInt(b['å°ˆé•·'])||99));
        return `
          <div class="card">
            <input type="checkbox" class="course-chk chk-box" value="${c.rowId}">
            <div class="course-info">
              <strong>${new Date(c['æ—¥æœŸ']).toLocaleDateString('zh-TW')} ${c['æ™‚é–“']}</strong> 
              <span class="status-badge">${c['ç‹€æ…‹'] || 'å¾µæ±‚ä¸­'}</span><br>
              ${c['èª²ç¨‹']} (åŸå¸«ï¼š${c['æŒ‡å°è€…']})
              ${c['æœ€å¾Œè©¢å•å°è±¡'] ? `<br><small style="color:blue">ğŸ“ æœ€å¾Œè©¢å•ï¼š${c['æœ€å¾Œè©¢å•å°è±¡']}</small>` : ''}
            </div>
            <div class="grid">${sortedT.map(t => `<button class="btn ${t['æ¢¯æ¬¡']||'t3'}" onclick="generateLink('${t['æŒ‡å°è€…']}')">${t['æŒ‡å°è€…']}</button>`).join('')}</div>
          </div>`;
      }).join('');
    }
    function generateLink(tName) {
      const selectedIds = Array.from(document.querySelectorAll('.course-chk:checked')).map(el => el.value);
      if (selectedIds.length === 0) return alert("è«‹å…ˆå‹¾é¸èª²ç¨‹ï¼");
      document.getElementById('loader').style.display = 'flex';
      const subUrl = window.location.href.replace('admin.html', 'sub.html');
      const finalUrl = `${subUrl}?name=${encodeURIComponent(tName)}&ids=${selectedIds.join(',')}`;
      Promise.all(selectedIds.map(id => fetch(`${APP_URL}?action=updateStatus&rowId=${id}&status=è©¢å•ä¸­&lastTeacher=${encodeURIComponent(tName)}`)))
      .then(() => {
        navigator.clipboard.writeText(`è€å¸«æ‚¨å¥½ï¼Œæƒ³è«‹å•é€™å¹¾å ‚èª²æ‚¨æ–¹ä¾¿ä»£èª²å—ï¼Ÿ\né€£çµï¼š${finalUrl}`).then(() => {
          document.getElementById('loader').style.display = 'none';
          alert(`å·²è¨˜éŒ„ç‚ºè©¢å• ${tName} ä¸­ï¼é€£çµå·²è¤‡è£½ã€‚`);
          fetchData();
        });
      });
    }
  </script>
</body>
</html>
