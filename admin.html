<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sherry å¾Œå°èª¿åº¦</title>
  <style>
    body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 15px; }
    .card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0; }
    .btn { padding: 10px; border-radius: 6px; text-decoration: none; text-align: center; font-size: 13px; font-weight: bold; color: white; }
    .t1 { background: #ff9800; } .t2 { background: #03a9f4; } .t3 { background: #90a4ae; }
    .other-skill { background: #fff; color: #bbb; border: 1px dashed #ddd; }
    .op-bar { display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #eee; padding-top: 10px; }
    .op-btn { border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>ğŸ’ ä»£èª²èª¿åº¦ä¸­å¿ƒ</h2>
  <div id="main">è®€å–ä¸­...</div>

  <script>
    const APP_URL = "https://script.google.com/macros/s/AKfycbyJADHe_DZdNIbfv_KPewAcBekEond-5Fw63i-RWCd1mHl_O9uGAQ-LTnzENZshjnhe/exec"; 
    let teachers = []; let courses = [];

    window.onload = () => {
      Promise.all([
        fetch(`${APP_URL}?action=getCourse&isAdmin=true`).then(r=>r.json()), 
        fetch(`${APP_URL}?action=getTeachers`).then(r=>r.json())
      ]).then(([cData, tData]) => {
        courses = cData.filter(d => d['æŒ‡å°è€…'] !== "æŒ‡å°è€…" && !d['ä»£èª²è€å¸«']);
        teachers = tData;
        render();
      });
    };

    function render() {
      const main = document.getElementById('main');
      if(courses.length===0) { main.innerHTML='<div style="text-align:center; padding:50px;">ç›®å‰æ²’æœ‰å¾…è™•ç†ç”³è«‹</div>'; return; }
      
      main.innerHTML = courses.map((c, i) => {
        let type = "å…¶ä»–"; 
        if (c['èª²ç¨‹'].includes('ç©ºç‘œ')) type = 'ç©ºç‘œ';
        else if (c['èª²ç¨‹'].includes('ç©ºç’°')) type = 'ç©ºç’°';
        else if (c['èª²ç¨‹'].includes('èˆç¶¢')) type = 'èˆç¶¢';

        const sortedT = [...teachers].sort((a,b) => {
          const am = a['å°ˆé•·'].includes(type) || a['å°ˆé•·'].includes('å…¨èƒ½');
          const bm = b['å°ˆé•·'].includes(type) || b['å°ˆé•·'].includes('å…¨èƒ½');
          return bm - am;
        });

        const msg = encodeURIComponent(`ã€Sherry ä»£èª²å¾µæ±‚ã€‘\næ—¥æœŸï¼š${c['æ—¥æœŸ']}\nèª²ç¨‹ï¼š${c['èª²ç¨‹']}\næ™‚é–“ï¼š${c['æ™‚é–“']}\nè«‹å•æ‚¨æœ‰ç©ºä»£èª²å—ï¼Ÿ`);

        return `
          <div class="card">
            <strong>${c['æ—¥æœŸ']} ${c['æ™‚é–“']}</strong><br>${c['èª²ç¨‹']} (${c['æŒ‡å°è€…']})
            <div class="grid">${sortedT.map(t => {
              const isMatch = t['å°ˆé•·'].includes(type) || t['å°ˆé•·'].includes('å…¨èƒ½');
              return `<a href="https://line.me/R/msg/text/?${msg}" target="_blank" class="btn ${isMatch ? t['æ¢¯æ¬¡'] : 'other-skill'}" 
                      onclick="update(${c.rowId},'è©¢å•ä¸­','','${t['æŒ‡å°è€…']}')">${isMatch ? '' : '(è·¨)'}${t['æŒ‡å°è€…']}</a>`;
            }).join('')}</div>
            <div class="op-bar">
              <button class="op-btn" style="background:#ffebee;color:#f44336" onclick="update(${c.rowId},'å·²å©‰æ‹’')">å©‰æ‹’</button>
              <button class="op-btn" style="background:#e8f5e9;color:#2e7d32" onclick="update(${c.rowId},'å·²æˆäº¤',true)">æˆäº¤é ˜å–</button>
            </div>
          </div>`;
      }).join('');
    }

    function update(rowId, status, isSuccess, lastT) {
      let url = `${APP_URL}?action=updateStatus&rowId=${rowId}&status=${status}`;
      if(lastT) url += `&lastTeacher=${lastT}`;
      if(isSuccess) {
        const name = prompt("æ˜¯å“ªä½è€å¸«ä»£èª²ï¼Ÿ");
        if(!name) return;
        url += `&subTeacher=${name}`;
      }
      fetch(url).then(() => { if(isSuccess || status==='å·²å©‰æ‹’') location.reload(); });
    }
  </script>
</body>
</html>
